<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="com.finalprj.kess.repository.IStudentRepository">
	<resultMap id="studentResult"
		type="com.finalprj.kess.model.StudentVO">
		<result property="stdtId" column="STDT_ID" />
		<result property="userEmail" column="STDT_EMAIL" />
		<result property="stdtNm" column="STDT_NM" />
		<result property="genderCd" column="GENDER_CD" />
		<result property="birthDd" column="BIRTH_DD" />
		<result property="stdtTel" column="STDT_TEL" />
		<result property="jobCd" column="JOB_CD" />
		<result property="rgstDt" column="RGST_DT" />
		<result property="rgsterId" column="RGSTER_ID" />
		<result property="updtDt" column="UPDT_DT" />
		<result property="updterId" column="UPDTER_ID" />
	</resultMap>

	<!-- 교육생 회원가입 -->
	<insert id="insertStudent"
		parameterType="com.finalprj.kess.model.StudentVO">
		<![CDATA[
		INSERT INTO stdt
			(stdt_id, stdt_email, stdt_pwd, stdt_nm, gender_cd, birth_dd, stdt_tel,
			job_cd, role_cd, stdt_cd, rgst_dt, rgster_id, updt_dt, updter_id)
		VALUES
			(#{stdtId}, #{stdtEmail}, #{stdtPwd}, #{stdtNm}, #{genderCd}, #{birthDd}, #{stdtTel},
			#{jobCd}, #{roleCd}, #{stdtCd}, #{rgstDt}, #{rgsterId}, #{updtDt}, #{updterId})
		]]>
	</insert>

	<!-- 교육생 로그인 -->
	<select id="selectUser" parameterType="string"
		resultType="com.finalprj.kess.model.StudentVO"
		resultMap="studentResult">
		<![CDATA[
		select *
		from stdt
		join lgin on lgin.user_email = stdt.user_email
		where stdt.user_email=#{email}
		]]>
	</select>

	<!-- 교육생 개인정보 수정 -->
	<update id="updateStudent"
		parameterType="com.finalprj.kess.model.StudentVO">
		<![CDATA[
		UPDATE stdt
		SET stdt_pwd=#{stdtPwd}, stdt_nm=#{stdtNm}, gender_cd=#{genderCd}, birth_dd=#{birthDd}, stdt_tel=#{stdtTel}, job_cd=#{jobCd}
		WHERE stdt_id=#{stdtId}
		]]>
	</update>

	<!-- 교육생 탈퇴 -->
	<delete id="deleteStudent"
		parameterType="com.finalprj.kess.model.StudentVO">
		<![CDATA[
		DELETE FROM stdt
		WHERE stdt_id=#{stdtId} AND stdt_pwd=#{stdtPwd}
		]]>
	</delete>

	<!-- 비밀번호 확인 -->
	<select id="getPassword" parameterType="string"
		resultType="string">
		<![CDATA[
		SELECT stdt_pwd
		FROM stdt
		WHERE stdt_id=#{stdtId}
		]]>
	</select>

	<!-- 공지사항 목록 조회 (메인) -->
	<select id="selectNoticeMain" parameterType="string"
		resultType="com.finalprj.kess.model.PostVO">
		<![CDATA[
		SELECT *
			  FROM (
					SELECT 
						post_id,
						post_title,
						post_cd,
						rgst_dt as "rgstDd"
					FROM post
					WHERE post_id LIKE 'NOTC%' and post_cd=
						(select cmcd_id
						from cmcd
						where cmcd_id='PST0000001')
					ORDER BY rgst_dt DESC
				)
				WHERE ROWNUM <= 5
		]]>
	</select>

	<!-- 공지사항 목록 조회 -->
	<select id="selectAllNotice" parameterType="string"
		resultType="com.finalprj.kess.model.PostVO">
		<![CDATA[
				SELECT 
					post_id,
					post_title,
					post_cd,
					post_hit,
					rgst_dt as "rgstDd"
				FROM post
				WHERE post_id LIKE 'NOTC%' and post_cd=
					(select cmcd_id
					from cmcd
					where cmcd_id='PST0000001')
				ORDER BY rgst_dt DESC

		]]>
	</select>

	<!-- 공지사항 상세 조회 -->
	<select id="selectNotice" parameterType="string"
		resultType="com.finalprj.kess.model.PostVO">
		<![CDATA[
		SELECT *
		FROM post
		WHERE post_id=#{postId}
		]]>
	</select>

	<!-- 문의사항 전체목록 조회 -->
	<select id="selectAllInquiry" parameterType="string"
		resultType="com.finalprj.kess.model.PostVO">
		<![CDATA[
		SELECT 
		    post_id,
		    post_title,
		    post_cd,
		    post_hit,
		    rgster_id,
		    rgst_dt as "rgstDd"
		FROM post
		WHERE post_id LIKE 'INQY%' AND post_cd IN (
		    SELECT cmcd_id
		    FROM cmcd
		    WHERE cmcd_id IN ('PST0000003', 'PST0000004')
		)
		ORDER BY rgst_dt DESC
		]]>
	</select>

	<!-- 문의사항 상세 조회 -->
	<select id="selectInquiry" parameterType="string"
		resultType="com.finalprj.kess.model.PostVO">
		<![CDATA[
			SELECT *
			FROM post
			WHERE post_id=#{postId}
		]]>
	</select>

	<!-- 교육지원목록 조회 (메인) -->
	<select id="selectClassMain" parameterType="string"
		resultType="com.finalprj.kess.model.ClassVO">
		<![CDATA[
			SELECT *
			  FROM (
				SELECT
				    clss_id,
				    clss_nm,
				    aply_start_dt as "aplyStartDd",
			    	aply_end_dt as "aplyEndDd",
				    clss_cd
				FROM clss
				WHERE clss_cd=
					(select cmcd_id
					from cmcd
					where cmcd_id='CLS0000002')
					ORDER BY rgst_dt DESC
			)
			WHERE ROWNUM <= 5
		]]>
	</select>

	<!-- 교육지원목록 조회 -->
	<select id="selectAllClass" parameterType="string"
		resultType="com.finalprj.kess.model.ClassVO">
		<![CDATA[
			SELECT
			   clss_id,
		       clss_nm,
		       clss.cmpy_id,
		       aply_start_dt as "aplyStartDd",
			   aply_end_dt as "aplyEndDd",
		       clss_start_dd,
		       clss_end_dd,
		       substr(clss_adr, 1, 3) as "clssAdr", 
		       limit_cnt,
		       clss_cd,
			   cmcd.cmcd_nm,
		       flup.file_nm 
		   FROM clss
		   JOIN cmcd on cmcd.cmcd_id = clss.clss_cd
		   LEFT JOIN cmpy on cmpy.cmpy_id = clss.cmpy_id
		   LEFT JOIN flup on flup.file_id = cmpy.file_id
		   WHERE clss.delete_yn= 'N' and clss.clss_cd <> 'CLS0000007'
		   ORDER BY clss.rgst_dt DESC
		]]>
	</select>

	<!-- 교육지원목록 검색 -->
	<select id="searchClasses" parameterType="string"
		resultType="com.finalprj.kess.model.ClassVO">
		<![CDATA[
			SELECT
			    clss_id,
			    clss_nm,
			    clss.cmpy_id,
			    aply_start_dt as "aplyStartDd",
			    aply_end_dt as "aplyEndDd",
			    clss_start_dd,
			    clss_end_dd,
			    substr(clss_adr, 1, 3) as "clssAdr", 
			    limit_cnt,
			    clss_cd,
			    cmcd.cmcd_nm,
			    flup.file_nm 
			FROM clss
			JOIN cmcd on cmcd.cmcd_id = clss.clss_cd
			LEFT JOIN cmpy on cmpy.cmpy_id = clss.cmpy_id
			LEFT JOIN flup on flup.file_id = cmpy.file_id
			WHERE clss_nm LIKE ('%'|| UPPER(#{keyword}) ||'%') and clss_cd LIKE (#{ingClass} ||'%') and clss.delete_yn= 'N' and clss.clss_cd <> 'CLS0000007'
			ORDER BY clss.rgst_dt DESC
		]]>
	</select>

	<!-- 교육지원 상세 조회 -->
	<select id="selectClass" parameterType="string"
		resultType="com.finalprj.kess.model.ClassVO">
		<![CDATA[
			SELECT
			    clss_id,
			    clss_nm,
			    clss_content,
			    aply_start_dt as "aplyStartDd",
			    aply_end_dt as "aplyEndDd",
			    clss_start_dd,
			    clss_end_dd,
			    clss_adr,
			    limit_cnt,
			    TO_CHAR(set_in_tm, 'HH24') as "setInTime",
    			TO_CHAR(set_out_tm, 'HH24') as "setOutTime",
    			clss_total_tm,
			    clss_etc,
			    clss_cd,
			    mngr.mngr_nm ,
			    cmpy.cmpy_nm ,
			    cmcd.cmcd_nm 
			FROM clss
			JOIN cmcd ON cmcd.cmcd_id = clss.clss_cd
			LEFT JOIN MNGR on mngr.mngr_id = clss.mngr_id
			LEFT JOIN cmpy ON cmpy.cmpy_id = clss.cmpy_id
			WHERE clss.clss_id = #{clssId}
		]]>
	</select>

	<!-- 교육지원 커리큘럼 -->
	<select id="getCurriculumList" parameterType="string"
		resultType="com.finalprj.kess.dto.CurriculumDetailDTO">
	<![CDATA[
		select lctr.lctr_nm, lctr.lctr_tm, sbjt.sbjt_nm, prof.prof_nm
		from crcl
        join lctr on lctr.lctr_id = crcl.lctr_id
        join sbjt on sbjt.sbjt_id = lctr.sbjt_id
        join prof on prof.prof_id = lctr.prof_id
        WHERE crcl.clss_id = #{clssId}
	]]>
	</select>


	<!-- 교육지원 상세 조회(이미지) -->
	<select id="selectAllClassFile" parameterType="string"
		resultType="com.finalprj.kess.model.FileVO">
		<![CDATA[
		SELECT
		    file_id,
		    file_sub_id,
		    file_nm,
		    file_content,
		    file_size,
		    SUBSTR(file_type, 1, INSTR(file_type, '/') - 1) as "fileType"
		FROM flup
		WHERE file_id = (
		    SELECT file_id
		    FROM clss
		    WHERE clss_id = #{clssId}
		) and flup.delete_yn= 'N'
		ORDER BY
	    CASE
	        WHEN file_type LIKE 'application%' THEN 0
	        WHEN file_type LIKE 'text%' THEN 1
	        ELSE 2
	    END
		]]>
	</select>

	<!-- 검색내역 리스트 -->
	<select id="selectviewClass" parameterType="string"
		resultType="com.finalprj.kess.model.ClassVO">
		<![CDATA[
			SELECT
			   clss_id,
		       clss_nm,
		       clss.cmpy_id,
		       clss_cd,
			   cmcd.cmcd_nm,
		   		flup.file_nm
		   FROM clss
		   JOIN cmcd on cmcd.cmcd_id = clss.clss_cd
		   LEFT JOIN cmpy on cmpy.cmpy_id = clss.cmpy_id
		   LEFT JOIN flup on flup.file_id = cmpy.file_id
		   WHERE clss.clss_id = #{viewClass}
		]]>
	</select>

	<!-- 중복지원 내역 확인하기 -->
	<select id="getAplyYN" parameterType="string" resultType="int">
	<![CDATA[
		select COALESCE(COUNT(aply_id), 0) as "applyYN"
			from aply
			where stdt_id = #{stdtId}
				and clss_id = #{classId}
	]]>
	</select>

	<!-- 이수 테이블 aplyId MAX값 가져오기 -->
	<select id="getMaxAplyId" resultType="string">
	<![CDATA[
		select 'APLY'||LPAD((max(cast(substr(aply_id,5) as number(6)))+1),6,'0')
		from aply
	]]>
	</select>

	<!-- 지원서 파일 업로드 -->
	<insert id="uploadAplyFile"
		parameterType="com.finalprj.kess.model.FileVO">
	<![CDATA[
		insert into aply
		values(#{aplyId}, #{stdtId}, #{clssId}, #{aplyCd}, #{fileId},systimestamp, #{rgsterId}, null, null)
	]]>
	</insert>



	<!-- 이수완료건 출력 -->
	<select id="getCmptClass" parameterType="string"
		resultType="int">
	<![CDATA[
		select COALESCE(COUNT(clss_id), 0) as "cmptClassCnt"
			from rgst
			where stdt_id= (
				SELECT stdt_id
				FROM stdt
				WHERE user_email=#{email}
				)
	            and cmpt_cd=
			(select cmcd_id
			from cmcd
			where cmcd_id='CMP0000002')
	]]>
	</select>


	<!-- 지원완료건 출력 -->
	<select id="getAplyClass" parameterType="string"
		resultType="int">
	<![CDATA[
		select COALESCE(COUNT(clss_id), 0) as "aplyClassCnt"
			from aply
			where stdt_id= (
				SELECT stdt_id
			FROM stdt
			WHERE user_email=#{email}
			) and aply_cd=
			(select cmcd_id
			from cmcd
			where cmcd_id='APL0000002')
	]]>
	</select>

	<!-- 수강중인 수업명 출력 -->
	<select id="getIngClass" parameterType="string"
		resultType="string">
	<![CDATA[
		select clss_nm
		from clss
		where clss_id =(
			select clss_id
				from rgst
				where stdt_id= (
					SELECT stdt_id
					FROM stdt
					WHERE user_email=#{email}
					)
		            and cmpt_cd=
				(select cmcd_id
				from cmcd
				where cmcd_id='CMP0000001')
			) and clss_cd=
			(select cmcd_id
			from cmcd
			where cmcd_id='CLS0000004')
	]]>
	</select>

	<!-- 지원내역 조회 -->
	<select id="searchAplyList" parameterType="string"
		resultType="com.finalprj.kess.dto.ApplyDetailDTO">
	<![CDATA[
		select 
			aply_id,
			clss_nm,
			aply_cd,
			aply_end_dt,
			aply_start_dt as "aplyStartDd",
			aply_end_dt as "aplyEndDd",
			clss_start_dd,
			clss_end_dd,
			limit_cnt,
			aply_cd,
			cmcd.cmcd_nm,
			aply.rgst_dt as "rgstDd",
			aply.updt_dt as "updtDd"
			FROM aply
			JOIN cmcd on cmcd.cmcd_id = aply.aply_cd
			JOIN clss on clss.clss_id = aply.clss_id
			WHERE stdt_id=#{stdtId}
			ORDER BY aply.rgst_dt DESC
	]]>
	</select>

	<!-- 마이페이지 지원상태 수정 -->
	<update id="updateaply"
		parameterType="com.finalprj.kess.model.ApplyVO">
	<![CDATA[
		update aply
		set 
			aply_cd = #{aplyCd}
		where aply_id=#{aplyId}
	]]>
	</update>

	<!-- 수강 테이블 RegistrationId MAX값 가져오기 -->
	<select id="getMaxRegistrationId" resultType="string">
	<![CDATA[
		select 'RGST'||LPAD((max(cast(substr(rgst_id,5) as number(6)))+1),6,'0')
		from rgst
	]]>
	</select>


	<!-- 마이페이지 수강내역 추가 -->
	<insert id="insertRgst"
		parameterType="com.finalprj.kess.model.RegistrationVO">
		<![CDATA[
		INSERT into rgst
		values(#{maxRgstId}, #{stdtId}, (select
            clss_id
           from aply
       where aply_id = #{aplyId}), 'RST0000001', 'CMP0000001',null,systimestamp, #{stdtId}, null, null)
        
		]]>
	</insert>

	<!-- 지원 테이블 fileSubId MAX값 가져오기 -->
	<select id="getmaxSubId" resultType="int">
	<![CDATA[
		select LPAD(max (FILE_SUB_ID), 1, '0')
		from flup
		where file_id = (select file_id
							from aply
							where aply_id =#{aplyId})
	]]>
	</select>

	<!-- 지원 테이블 파일 수정 -->
	<insert id="updateAplyFile"
		parameterType="com.finalprj.kess.model.FileVO">
	<![CDATA[
		update flup
			set 
			file_sub_id = #{maxFileSubId},
			file_nm = #{fileVO.fileNm},
			file_content = #{fileVO.fileContent},
			file_size = #{fileVO.fileSize},
			file_type = #{fileVO.fileType}
			where file_id=
				(select file_id
				from aply
				where aply_id = #{aplyId}	
				)	
	]]>
	</insert>
	
	<!-- 지원 수정 날짜 업데이트 -->
	<insert id="updateAplydt">
	<![CDATA[
		update aply
		set 
			updter_id = #{stdtId},
			updt_dt = systimestamp
		where aply_id = #{aplyId}	
	]]>
	</insert>

</mapper>