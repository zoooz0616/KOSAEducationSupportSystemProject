<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{/include/manager_header :: header}">
<meta charset="UTF-8">
<title>Create Class</title>
</head>
<head>
<link th:href="@{/css/admin/class_form.css}" rel="stylesheet">
<link href="/css/datepicker.css" rel="stylesheet" type="text/css"
	media="all">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Air datepicker css -->
<script src="/js/datepicker.js"></script>
<!-- Air datepicker js -->
<script src="/js/datepicker.ko.js"></script>
<!-- 달력 한글 추가를 위해 커스텀 -->
</head>
<body>
	<!-- 서브바-->
	<div th:replace="~{/include/manager_subbar :: subbar}"></div>
	<!-- 서브바 -->

	<!-- Content Wrap -->
	<div class="home-section">

		<!-- Content Top -->
		<div class="content_top">
			<!-- Title -->
			<div class="title" th:text="${title}">title</div>
			<!-- Route -->
			<div class="route">
				> <a th:href="@{/admin}">대시보드</a> > <a th:href="@{/admin/class}">교육과정
					관리</a> > <a th:href="@{/admin/class/__${act}__}" th:text="${title}">title</a>
			</div>
		</div>
		<!-- Content Top -->

		<!-- Content Middle-->
		<div class="content_middle">
			<!-- 컨텐츠 내용 부분 -->
			<form th:action="@{/admin/class/__${act}__}" method="post"
				enctype="multipart/form-data">
				<!-- 교육과정 id -->
				<input type="hidden" name="clssId" th:value="${classVO.clssId}">

				<div class="class_form_content">
					<div class="row">
						<div class="col">
							<div class="col_title">교육과정 ID</div>
							<div class="col_content">
								<input th:if="${act}=='insert'" type="text"
									th:value="${classVO.clssId}" readonly disabled required>
								<input th:if="${act}=='update'" type="text"
									th:value="${classVO.clssId}" required>
							</div>
						</div>

						<div class="col">
							<div class="col_title">교육과정명</div>
							<div class="col_content" style="width: 200px;">
								<input style="width: 200px;" th:if="${act}=='insert'"
									name="clssNm" type="text" required> <input
									style="width: 200px;" th:if="${act}=='update'" type="text"
									th:value="${classVO.clssNm}" required>
							</div>

						</div>

						<div class="col">
							<div class="col_title">지원 기간</div>
							<div class="col_content">
								<input th:if="${act}=='insert'" type="datetime-local"
									name="aplyStartDt" required> <input
									th:if="${act}=='update'" type="datetime-local"
									th:value="${classVO.aplyStartDt}" required> ~ <input
									th:if="${act}=='insert'" type="datetime-local"
									name="aplyStartDt" required> <input
									th:if="${act}=='update'" type="datetime-local"
									th:value="${classVO.aplyEndDt}" required>
							</div>
						</div>

						<div class="col">
							<div class="col_title">교육 기간</div>
							<div class="col_content">
								<input th:if="${act}=='insert'" id="datepicker1" type="text"
									value="연도-월-일" name="clssStartDd" required> <input
									th:if="${act}=='update'" id="datepicker1" type="text"
									th:value="${classVO.clssStartDd}" required> ~ <input
									th:if="${act}=='insert'" id="datepicker2" type="text"
									name="clssEndDd" required> <input
									th:if="${act}=='update'" id="datepicker2" type="text"
									th:value="${classVO.clssEndDd}" required>
							</div>
						</div>


					</div>


					<div class="row">
						<div class="col">
							<div class="col_title">교육 시간</div>
							<div class="col_content">
								<input th:if="${act}=='insert'" type="time" name="setInTm"
									required> <input th:if="${act}=='update'" type="time"
									required> ~ <input th:if="${act}=='insert'" type="time"
									name="setOutTm" required> <input
									th:if="${act}=='update'" type="time"
									th:value="${classVO.setOutTm}" required>
							</div>
						</div>

						<div class="col">
							<div class="col_title">교육 장소</div>
							<div class="col_content" style="width: 300px;">
								<input style="width: 100%;" th:if="${act}=='insert'" type="text"
									name="clssAdr" required> <input style="width: 100%;"
									th:if="${act}=='update'" type="text"
									th:value="${classVO.clssAdr}" required>
							</div>
						</div>

						<div class="col">
							<div class="col_title">교육 상태</div>
							<div class="col_content">
								<select>
									<option th:each="classStatus: ${classCodeNameList}"
										th:value="${classStatus}" th:text="${classStatus}"></option>
								</select>
							</div>
						</div>

						<div class="col">
							<div class="col_title" style="width: 80px; text-align: center;">업체</div>
							<div class="col_content">
								<select>
									<option th:each="company: ${companyList}"
										th:value="${company.cmpyId}" th:text="${company.cmpyNm}"></option>
								</select>
							</div>
						</div>

						<div class="col">
							<div class="col_title" style="width: 80px; text-align: center;">인원</div>
							<div class="col_content">
								<input th:if="${act}=='insert'" type="number" required>
								<input th:if="${act}=='update'" type="number"
									th:value="${classVO.limitCnt}" required>
							</div>

						</div>

						<div class="col">
							<div class="col_title">업무 담당자</div>
							<div class="col_content">
								<select>
									<option th:each="manager: ${managerList}"
										th:value="${manager.mngrId}" th:text="${manager.mngrNm}"></option>
								</select>
							</div>
						</div>
					</div>

					<div class="row2">
						<div class="col2">
							<div class="col_title">교육 개요</div>
							<div class="col_content" style="width: 350px; height: 100%;">
								<div
									style="border: 1px solid #777777; display: flex; justify-content: center; align-items: center; border-radius: 5px; background: white; width: 100%; height: 100%;">
									<input type="text"
										style="width: 97%; border: none; outline: none; background: white; height: 97%;">
								</div>
							</div>
						</div>

						<div class="col2">
							<div class="col_title">강의 내용</div>
							<div class="col_content" style="width: 900px;">
								<div class="content_info_btn_wrap">
									<!-- 선택삭제 버튼 -->
									<button>
										<img th:src="@{/img/minus_white.png}"><span>선택삭제</span>
									</button>

									<!-- 추가하기 버튼 -->
									<button onclick="addLecture()">
										<img th:src="@{/img/plus_white.png}"><span>추가하기</span>
									</button>
								</div>
								<div>
									<table class="lecture_table">
										<tr>
											<th><input type="checkbox"></th>
											<th><div>강의명(이수시간)</div></th>
											<th><div>과목명</div></th>
											<th><div>강사이름</div></th>
										</tr>
										<tr class="lecture_row">
											<td><input type="checkbox"></td>
											<td><select id="lecture_select"
												onchange="lectureSelect(this.value)">
													<option value="none">=== 강의를 선택하세요. ===</option>
													<option th:each="lecture: ${lectureList}"
														th:value="${lecture.lctrId}"
														th:text="${lecture.lctrNm}+' ('+${lecture.lctrTm}+')'"></option>
											</select></td>
											<td><input id="subject_name" name="" type="text"
												value="subjectName" disabled></td>
											<td><input id="professor_name" name="" type="text"
												value="professorName" disabled></td>
										</tr>
									</table>
									<div>
										<div>
											총 이수시간 : <span class="class_total_tm">0</span>
										</div>
									</div>

								</div>
							</div>
						</div>
					</div>

					<div class="row2">
						<div class="col2">
							<div class="col_title">파일 첨부</div>
							<div class="col_content" style="width: 500px;">
								<div>
									<input type="file" name="files" id="file"
										class="files form-control form-control-sm" multiple>
								</div>
								<div class="file_drag" id="file_drag">
									<div class="file_list_header" style="display: none;">
										<div class="file_list_header_task">
											<button type="button" id="removeAll_button">
												<span class="blind">X</span>
											</button>
										</div>
										<div class="file_list_header_title">
											<span class="text">파일명</span>
										</div>
										<div class="file_list_header_volume">
											<span class="text">총용량 </span><span id="fileSize">0</span>
										</div>
									</div>

									<ul id="fileList"></ul>
								</div>

							</div>
						</div>
						<div class="col2">
							<div class="col_title">기타</div>
							<div class="col_content" style="width: 500px; height: 100%;">
								<div
									style="border: 1px solid #777777; display: flex; justify-content: center; align-items: center; border-radius: 5px; background: white; width: 100%; height: 100%;">
									<input type="text"
										style="width: 97%; border: none; outline: none; background: white; height: 97%;">
								</div>
							</div>
						</div>
					</div>
				</div>


				<!-- create일 때 -->
				<input th:if="${act}=='insert'" type="submit" value="저장하기">
				<!-- update일 때 -->
				<input th:if="${act}=='update'" type="submit" value="수정하기">
			</form>
		</div>
		<!-- Content Middle-->
	</div>
	<!-- Content Wrap -->
	<script>
		classTotalTm = 0; //교육과정 총 이수시간
	
	
	
		/*
		 * 달력 생성기
		 * @param sDate 파라미터만 넣으면 1개짜리 달력 생성
		 * @example   datePickerSet($("#datepicker"));
		 * @param sDate, 
		 * @param eDate 2개 넣으면 연결달력 생성되어 서로의 날짜를 넘어가지 않음
		 * @example   datePickerSet($("#datepicker1"), $("#datepicker2"));
		 */
		datePickerSet($("#datepicker1"), $("#datepicker2"), true); //다중은 시작하는 달력 먼저, 끝달력 2번째
		function datePickerSet(sDate, eDate, flag) {

			//시작 ~ 종료 2개 짜리 달력 datepicker	
			if (!isValidStr(sDate) && !isValidStr(eDate) && sDate.length > 0
					&& eDate.length > 0) {
				var sDay = sDate.val();
				var eDay = eDate.val();

				if (flag && !isValidStr(sDay) && !isValidStr(eDay)) { //처음 입력 날짜 설정, update...			
					var sdp = sDate.datepicker().data("datepicker");
					sdp.selectDate(new Date(sDay.replace(/-/g, "/"))); //익스에서는 그냥 new Date하면 -을 인식못함 replace필요

					var edp = eDate.datepicker().data("datepicker");
					edp.selectDate(new Date(eDay.replace(/-/g, "/"))); //익스에서는 그냥 new Date하면 -을 인식못함 replace필요
				}

				//시작일자 세팅하기 날짜가 없는경우엔 제한을 걸지 않음
				if (!isValidStr(eDay)) {
					sDate.datepicker({
						maxDate : new Date(eDay.replace(/-/g, "/"))
					});
				}
				sDate.datepicker({
					language : 'ko',
					autoClose : true,
					onSelect : function() {
						datePickerSet(sDate, eDate);
					}
				});

				//종료일자 세팅하기 날짜가 없는경우엔 제한을 걸지 않음
				if (!isValidStr(sDay)) {
					eDate.datepicker({
						minDate : new Date(sDay.replace(/-/g, "/"))
					});
				}
				eDate.datepicker({
					language : 'ko',
					autoClose : true,
					onSelect : function() {
						datePickerSet(sDate, eDate);
					}
				});

				//한개짜리 달력 datepicker
			} else if (!isValidStr(sDate)) {
				var sDay = sDate.val();
				if (flag && !isValidStr(sDay)) { //처음 입력 날짜 설정, update...			
					var sdp = sDate.datepicker().data("datepicker");
					sdp.selectDate(new Date(sDay.replace(/-/g, "/"))); //익스에서는 그냥 new Date하면 -을 인식못함 replace필요
				}

				sDate.datepicker({
					language : 'ko',
					autoClose : true
				});
			}

			function isValidStr(str) {
				if (str == null || str == undefined || str == "")
					return true;
				else
					return false;
			}
		}

		/*
		 * 커리큘럼 선택시 과목/강사명 자동입력
		 * 선택한 강의를 이용하여 비동기요청을 보내고 해당 과목명, 강사명을 받아옴. 
		 *
		 */
		function lectureSelect(lectureId) {
			var selectedLectureId = lectureId;
			console.log(selectedLectureId);

			// 선택한 강의 ID를 이용하여 비동기 요청을 보냅니다.
			$.ajax({
				url : "/admin/class/insert/lectureselect", // 컨트롤러 엔드포인트
				type : "POST",
				data : {
					lectureId : selectedLectureId
				}, // 선택한 강의 ID를 전달
				success : function(response) {
					//서버에서 받은 응답 파싱하여 객체로 생성
					var subject = response.subject;
					var professor = response.professor;
					var lecture = response.lecture;
					
					var subjectId = subject.sbjtId;
					var subjectNm = subject.sbjtNm;
					var professorId = professor.profId;
					var professorNm = professor.profNm;
					
					var lctrTm = lecture.lctrTm;
					
					
					// 서버에서 받은 데이터를 사용하여 subjectName과 professorName을 업데이트합니다.
					$("#subject_name").val(subjectNm);
					$("#subject_name").attr("name", subjectId);
					$("#professor_name").val(professorNm);
					$("#professor_name").attr("name", professorId);
					
					classTotalTm += lctrTm;
					$(".class_total_tm").text(classTotalTm);
				},
				error : function() {
					// 오류 처리 로직을 추가할 수 있습니다.
				}
			});
		}

		/*
		 * 추가하기 버튼 클릭시
		 * 강의 한 줄 더 추가
		 *
		 */
		
		var lectureCnt = 0;
		function addLecture() {
			if(lectureCnt < 4){
			$.ajax({
				url : "/admin/class/insert/getlecturelist", // 컨트롤러 엔드포인트
				type : "POST",
				data : {},
				success : function(response) {
					//서버에서 받은 응답 파싱하여 객체로 생성
					var lectureList = response.lectureList;
					
					
					console.log(lectureList[0].lctrNm);
					
					//tr을 새로 생성하고 안의 내용 복제
					// 새로운 행을 생성
					var newRow = document.createElement('tr');
					newRow.className = 'lecture_row'; // class 설정

					// 첫 번째 셀 (checkbox) 추가
					var checkboxCell = document.createElement('td');
					checkboxCell.innerHTML = '<input type="checkbox">';
					newRow.appendChild(checkboxCell);

					// 두 번째 셀 (강의 선택) 추가
					var lectureCell = document.createElement('td');
					// 새로운 select 요소 생성
					var select = document.createElement('select');
					
					
					// 옵션 요소 동적으로 생성
			        var defaultOption = document.createElement('option');
			        defaultOption.value = 'none';
			        defaultOption.text = '=== 강의를 선택하세요. ===';
			        select.appendChild(defaultOption);

			        for (var i = 0; i < lectureList.length; i++) {
			            var lecture = lectureList[i];
			            var option = document.createElement('option');
			            option.value = lecture.lctrId;
			            option.text = lecture.lctrNm + ' (' + lecture.lctrTm + ')';
			            select.appendChild(option);
			        }

			        lectureCell.appendChild(select);
					newRow.appendChild(lectureCell);

					// 세 번째 셀 (과목명) 추가
					var subjectCell = document.createElement('td');
					subjectCell.innerHTML = '<input name="" type="text" value="subjectName" disabled>';
					newRow.appendChild(subjectCell);

					// 네 번째 셀 (강사 이름) 추가
					var professorCell = document.createElement('td');
					professorCell.innerHTML = '<input name="" type="text" value="professorName" disabled>';
					newRow.appendChild(professorCell);

					
					
					
					select.onchange = function() {
						var selectedLectureId = this.value;
						// select 요소의 부모 td 요소 찾기
						var tdElement = this.parentElement;
						var thirdTdElement = tdElement.nextElementSibling;
						var fourthTdElement = thirdTdElement.nextElementSibling;
						
						var thirdInputElement = thirdTdElement.firstElementChild;
						var fourthInputElement = fourthTdElement.firstElementChild;
						
						// 선택한 강의 ID를 이용하여 비동기 요청을 보냅니다.
						$.ajax({
							url : "/admin/class/insert/lectureselect", // 컨트롤러 엔드포인트
							type : "POST",
							data : {
								lectureId : selectedLectureId
							}, // 선택한 강의 ID를 전달
							success : function(response) {								
								//서버에서 받은 응답 파싱하여 객체로 생성
								var subject = response.subject;
								var professor = response.professor;
								var lecture = response.lecture;

								var subjectId = subject.sbjtId;
								var subjectNm = subject.sbjtNm;
								var professorId = professor.profId;
								var professorNm = professor.profNm;							
								var lctrTm = lecture.lctrTm;

								// 서버에서 받은 데이터를 사용하여 subjectName과 professorName을 업데이트합니다.
								thirdInputElement.value=subjectNm;
								thirdInputElement.setAttribute("name", subjectId);
								fourthInputElement.value=professorNm;
								fourthInputElement.setAttribute("name", professorId);
								
								classTotalTm += lctrTm;
								$(".class_total_tm").text(classTotalTm);
							},
							error : function() {
								// 오류 처리 로직을 추가할 수 있습니다.
							}
						});
					};
					
					
					// 테이블에 새로운 행 추가
					var table = document
							.querySelector('.lecture_table');
					
					table.appendChild(newRow);

					//select의 option을 lectureList로 추가.
					},
				error : function() {
					// 오류 처리 로직을 추가할 수 있습니다.
				}
			});
			lectureCnt = lectureCnt + 1;
			}
		}
	</script>
</body>
</html>