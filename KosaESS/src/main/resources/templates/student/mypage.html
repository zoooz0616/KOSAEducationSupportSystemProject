<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<link th:href="@{/css/student/header.css}" rel="stylesheet">
<link th:href="@{/css/student/main.css}" rel="stylesheet">
<link th:href="@{/css/student/subbar.css}" rel="stylesheet">
<link th:href="@{/css/student/mypage.css}" rel="stylesheet">
<link rel="icon" href="/img/icon.png" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<meta charset="UTF-8">
<title>main page</title>
</head>
<body>
	<div th:replace="~{/include/student_header :: header}"
		style="width: 100%;"></div>

	<div class="container">
		<div class="maintext">
			<h1 style="color: #0E5881; margin-top: 3%;">마이페이지</h1>
		</div>
		<div class="content">
			<div th:replace="~{/include/student_subbar :: subbar}"></div>
			<div class="maincontent">
				<div class="personalData">
					<h3>개인 정보 조회/수정</h3>
					<p>비밀번호 확인</p>
				</div>
				<div class="applyList" style="display: none;">
					<h3>교육 과정 지원 내역</h3>
					<div>
						<table class="applyTable">
							<thead>
								<tr>
									<th>번호</th>
									<th>교육 과정 명</th>
									<th>지원기간</th>
									<th>교육기간</th>
									<th>정원</th>
									<th>지원 날짜</th>
									<th>지원 상태</th>
									<th colspan="2">수정/수강</th>
								</tr>
							</thead>
							<tbody>
								<tr class="aplyRow"
									th:each="ApplyDetailDTO , rowStat : ${applyList}">
									<td><span th:text="${rowStat.index + 1}"></span></td>
									<td th:text="${ApplyDetailDTO.clssNm}"></td>
									<td
										th:text="${ApplyDetailDTO.aplyStartDd} +' ~ '+ ${ApplyDetailDTO.aplyEndDd}"></td>
									<td
										th:text="${ApplyDetailDTO.clssStartDd} +' ~ '+ ${ApplyDetailDTO.clssEndDd}"></td>
									<td th:text="${ApplyDetailDTO.limitCnt}"></td>
									<td th:text="${ApplyDetailDTO.rgstDd}"></td>
									<td th:text="${ApplyDetailDTO.cmcdNm}"></td>
									<td><button class="update">수정</button>
										<button class="apply">수강</button></td>
									<td><button class="cancel">지원취소</button>
										<button class="drop">수강포기</button></td>
									<td style="display: none;"><span
										th:text="${ApplyDetailDTO.aplyId}"></span></td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
				<div class="completeList" style="display: none;">
					<h3>교육 과정 이수 내역</h3>
					<div>
						<table class="rgstTable">
							<thead>
								<tr>
									<th>번호</th>
									<th>교육 과정 명</th>
									<th>교육기간</th>
									<th>수강상태</th>
									<th>이수 상태</th>
									<th>이수증 다운로드</th>
								</tr>
							</thead>
							<tbody>
								<tr class="rgstRow"
									th:each="RegistrationVO , rowStat : ${rgstList}">
									<td><span th:text="${rowStat.index + 1}"></span></td>
									<td th:text="${RegistrationVO.clssNm}"></td>
									<td
										th:text="${RegistrationVO.clssStartDd} +' ~ '+ ${RegistrationVO.clssEndDd}"></td>
									<td th:text="${RegistrationVO.rgstNm}"></td>
									<td th:text="${RegistrationVO.cmptNm}"></td>
									<td class="rgstPrint" style="display: none;"><a
										th:href="@{/download/file/__${RegistrationVO.fileId}__/__${RegistrationVO.fileSubId}__}"
										th:title="${RegistrationVO.fileNm}"> <img
											style="width: 30px;" th:src="@{/img/file_icon.png}"
											alt="file  아이콘"></a></td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
				<div class="workLog" style="display: none;">
					<h3>출퇴근 관리</h3>
					<div>
						<table class="wlogTable">
							<thead>
								<tr>
									<th>번호</th>
									<th>교육 과정 명</th>
									<th>출근 시간</th>
									<th>퇴근 시간</th>
									<th>출퇴근 상태</th>
									<th>사유서 제출</th>
								</tr>
							</thead>
							<tbody>
								<tr class="wlogRow" th:each="WorklogVO , rowStat : ${wlogList}">
									<td><span th:text="${rowStat.index + 1}"></span></td>
									<td th:text="${WorklogVO.clssNm}"></td>
									<td th:text="${WorklogVO.InTm}"></td>
									<td th:text="${WorklogVO.outTm}"></td>
									<td th:text="${WorklogVO.cmcdNm}"></td>
									<td><button class="submitResn" style="display: none;">제출</button>
										<button class="updateResn" style="display: none;">제출</button>
									</td>
									<td style="display: none;" th:text="${WorklogVO.wlogId}" class="wlogId"></td>
									<td style="display: none;" th:text="${WorklogVO.resnId}" class="resnId"></td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
				<div class="modal1" style="display: none;">
					<div class="modalBody">
						<div class="modalHeader">
							<h2 class="modalTitle" style="margin: 0;">지원하기</h2>
						</div>
						<div class="modalContent">
							<div class="upload-area">
								<p>지원서파일을 여기에 첨부하세요.</p>
								<input type="file" name="file" id="fileInput">
							</div>
						</div>
						<div class="modalFooter">
							<button type="reset" class="closeModalBtn">취소</button>
							<button type="submit" class="aplyBtn">수정하기</button>
						</div>
					</div>
				</div>
				<div class="modal2" style="display: none;">
					<div class="modalBody">
						<div class="modalHeader">
							<h2 class="modalTitle" style="margin: 0;">지원하기</h2>
						</div>
						<div class="modalContent">
							<div class="upload-area">
								<p>사유서파일을 첨부하세요.</p>
								<input type="file" name="file" id="fileInput">
							</div>
							<div>
								<label>사유서 내용을 작성하세요.</label> <input type="text"
									class="resnText">
							</div>
						</div>

						<div class="modalFooter">
							<button type="reset" class="closeBtn">취소</button>
							<button type="submit" class="sumbitBtn">제출하기</button>
						</div>
					</div>
					<div class="modal3" style="display: none;">
						<div class="modalBody">
							<div class="modalHeader">
								<h2 class="modalTitle" style="margin: 0;">지원하기</h2>
							</div>
							<div class="modalContent">
								<div class="upload-area">
									<p>사유서파일을 첨부하세요.</p>
									<input type="file" name="file" id="fileInput">
								</div>
								<div>
									<label>사유서 내용을 작성하세요.</label> <input type="text"
										class="resnText">
								</div>
							</div>

							<div class="modalFooter">
								<button type="reset" class="closeBtn">취소</button>
								<button type="submit" class="sumbitBtn">수정하기</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script th:inline="javascript">
		/* JavaScript에서 Java 모델의 값을 가져와서 처리 */
		var rgstList = /*[[${rgstList}]]*/[];

		for (var i = 0; i < rgstList.length; i++) {
			var cmptCd = rgstList[i].cmptCd;
			var rgstPrintElement = $('.rgstPrint').eq(i);

			if (cmptCd === 'CMP0000002') {
				rgstPrintElement.css('display', 'block');
			}
		}

		var wlogList = /*[[${wlogList}]]*/[];

		for (var i = 0; i < wlogList.length; i++) {
			var wlogCd = wlogList[i].wlogCd;
			var wlogId = wlogList[i].wlogId;
			var resnId = wlogList[i].resnId;
			var j = null;
			var submitResnElement = $('.submitResn').eq(i); // 클래스 이름 수정
			var updateResnElement = $('.updateResn').eq(i);

			if (wlogCd !== 'WOK0000001') {
				if (resnId == null)
					submitResnElement.css('display', 'block');
				else
					updateResnElement.css('display', 'block');
			}
		}
		</script>
		<script>
		var modal2 = $('.modal2');
		var wlogTable = $('.wlogTable');
		wlogTable.on('click', '.submitResn', function() {
			var clickedRow = $(this).closest('tr');
			var resnId = clickedRow.find('td:hidden span').text();
			modal2.show();

			// 모달 내부의 .sumbitBtn 버튼 클릭 시
			modal2.on('click', '.sumbitBtn', function() {
				var clickedRow = $(this).closest('tr');
				var wlogId = clickedRow.find('.wlogId').text();
				var resnText = $('.resnText');
				let formData = new FormData();
				let file = document.querySelector("#fileInput").files[0]; // 파일 인풋 필드에서 파일을 가져옴
				formData.append("formData", file); // FormData에 파일 추가

				$.ajax({
					type : 'POST',
					url : '/student/mypage/sumbitResn' +wlogId,
					data : {formData, resnText :resnText},// FormData 사용
					processData : false,
					contentType : false,
					success : function() {
						modal2.hide(); // 모달을 숨기기 위해 hide() 메서드 사용
						alert("사유서를 제출하였습니다.");
					}
				});
			});
			modal2.on('click', '.closeBtn', function() {
				modal2.hide();
		}); 
			
			var modal3 = $('.modal3');
		wlogTable.on('click', '.updateResn', function() {
				var clickedRow = $(this).closest('tr');
				var resnId = clickedRow.find('resnId').text();
				modal3.show();

				// 모달 내부의 .sumbitBtn 버튼 클릭 시
				modal3.on('click', '.sumbitBtn', function() {
					var resnText = $('.resnText');
					let formData = new FormData();
					let file = document.querySelector("#fileInput").files[0]; // 파일 인풋 필드에서 파일을 가져옴
					formData.append("formData", file); // FormData에 파일 추가

					$.ajax({
						type : 'POST',
						url : '/student/mypage/uploadResn/' + resnId,
						data : {formData, resnText :resnText},// FormData 사용
						processData : false,
						contentType : false,
						success : function() {
							modal2.hide(); // 모달을 숨기기 위해 hide() 메서드 사용
							alert("사유서를 제출하였습니다.");
						}
					});
				});
				modal3.on('click', '.closeBtn', function() {
					modal3.hide();
			}); 
	</script>
		<script src="/js/student/sidebar.js"></script>
		<script src="/js/student/mypage.js"></script>
</body>
</html>