<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{/include/manager_header :: header}">
<meta charset="UTF-8">
<title>Manager Student List</title>
</head>
<head>
	<link th:href="@{/css/manager/manager_class_list.css}" rel="stylesheet" />
	<link th:href="@{/css/manager/manager_post_list.css}" rel="stylesheet">
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
	<!-- 서브바 부분 -->
	<div th:replace="~{/include/manager_subbar_2 :: subbar}"></div>
	<!-- End 서브바 -->

	<!-- 컨텐츠 부분 -->
	<div class="home-section">
		<!-- title -->
		<div class="title_wrap">
			<span class="title" th:text="|${title} : ${thisClassName}|"></span><a th:text="${thisClassName}" th:href="@{/manager/class/__${}__}"></a>
		</div>

		<!-- content wrap-->
		<div class="content_wrap">
			<!-- 검색 필터 부분 -->
			<div class="search_filter_wrap">
				<!-- 검색 필터 테이블 -->
				<div class="search_filter_table_wrap">
					<table class="search_filter_table" style="width: 100%;">
						<tr>
							<td style="width: 10%;">교육과정명</td>
<!-- 							<td style="width: 30%;"><select id="classId"> <option th:each="className:${classNameList}" th:text="${className.clssNm}" th:value="${className.clssId}"></option></select></td> -->
							<td style="width: 30%;">
								<input id="class_name" placeholder="교육과정명" style="width: 100%;" type="text" list="search_option">
								<datalist id="search_option">
									<option th:each="class:${classList}" th:value="${class.clssNm}">
								</datalist>
							</td>
							<td style="width: 10%;">기간</td>
							<td style="width: 30%;"><input type="date" id="startDate"><span> ~ </span><input type="date" id="endDate"></td>
						</tr>
					</table>
					<!-- 검색 버튼 -->
				</div>
				<div class="search_filter_btn_wrap">
					<button class="search_filter_btn" th:id="searchButton"
						onclick="search()">검색</button>
				</div>
			</div>
			<!-- End 검색 버튼 -->
			<span th:text="${stdtCnt}" id="stdtCnt"></span><span>명</span>
			<span th:each="cmptCodeName:${cmptCodeNameList}">
				<button th:value="${cmptCodeName.cmcdId}" th:text="${cmptCodeName.cmcdNm}"></button>
			</span>
			<table id="stdt_list_table">
			<thead>
				<tr id="stdt_list_table_head">
					<th><input type="checkbox" id="chkAllStdt"></th>
					<th>번호</th>
					<th>이름</th>
					<th th:each="wlogCodeName:${wlogCodeNameList}"
						th:text="${wlogCodeName.cmcdNm}"></th>
					<th>성별</th>
					<th>생년월일</th>
					<th>이메일</th>
					<th>연락처</th>
					<th>이수여부</th>
				</tr>
				</thead>
				<tbody id="stdt_list_table_tbody">
				<tr th:each="stdt:${stdtList}" id="stdt_list_table_row">
					<td><input type="checkbox" id="chkStdt"></td>
					<td th:text="${stdtStat.count}"></td>
					<td th:text="${stdt.stdtNm}"></td>
					<td th:each="wlogCodeName:${wlogCodeNameList}" th:text="${#strings.substring(#strings.setSplit(stdt.wlogCnt,',')[wlogCodeNameStat.count-1],10,)}">?</td>
					<td th:text="${stdt.genderCd}">성별</td>
					<td th:text="${stdt.birthDd}">생년월일</td>
					<td th:text="${stdt.userEmail}">이메일</td>
					<td th:text="${stdt.stdtTel}">연락처</td>
					<td th:text="${stdt.jobCd}">이수여부</td>
				</tr>
				</tbody>
			</table>
			<!-- End 검색 필터 부분 -->
		</div>
	</div>

	<script>
	//전체 선택
	const chkAll = document.getElementsById("chkAllStdt");
	chkAll.addEventListener("change", () => {
		const chkList = document.getElementsById("chkStdt");
		for(chk of chkList){
			chk.checked = chkAll.checked;
		}
	});
	
	function search() {
		var classId=document.getElementById('classId').options[document.getElementById('classId').selectedIndex].value;
		var startDate = document.getElementById("startDate").value;
		var endDate = document.getElementById("endDate").value;
		var date = new Date();
		var year = date.getFullYear();
	 	function getFirstDay(){var month = ("0" + (1 + date.getMonth())).slice(-2);var day = "01";return year + "-" + month + "-" + day;}
	 	function getLastDay(){var month = ("0" + (1 + date.getMonth())).slice(-2);var lastDay = new Date(year,month, 0).getDate();return year + "-" + month + "-" + lastDay;}
	 	if(startDate==''){startDate=getFirstDay();}
	 	if(endDate==''){endDate=getLastDay();}
	 	
		$.ajax({
			type:'get',
			url:'/manager/student/search', // 서버의 엔드포인트 URL
// 			/*data: { classId<<컨트롤러에서 받는 위치: classId<<클라이언트가 보내는거})*/
			data: {
				classId:classId
 				, startDate:startDate
 				, endDate:endDate
			},
			async:false,
			success: function(stdtListResponse) {
				//테이블의 모든 내용을 삭제
				var stdtListTable = document.getElementById('stdt_list_table_tbody');
				while (stdtListTable.firstChild) {
					stdtListTable.removeChild(stdtListTable.firstChild);
				}
				
				console.log(stdtListTable);
				
				console.log("asdasdadasadasdasdasdadsasd");

				var stdtList = stdtListResponse.stdtList;
				document.getElementById("stdtCnt").innerHTML=stdtList.length;

				for(let i = 0; i < stdtList.length; i++){
					var newRow = document.createElement("tr");
					newRow.id="stdt_list_table_row";
					
					var rowChk = document.createElement('td');
					var inputChk = document.createElement('input');
					inputChk.id = 'chkStdt';
					inputChk.type = 'checkBox';
					rowChk.appendChild(inputChk);
					newRow.appendChild(rowChk);
					
					var rowNum = document.createElement('td');
					rowNum.innerHTML=i+1;
					newRow.appendChild(rowNum);
					
					var rowName = document.createElement('td');
					rowName.innerHTML=stdtList[i].stdtNm;
					newRow.appendChild(rowName);
					$.ajax({
						type:'get',
						url:'/manager/student/search/codename',
						async:false,
						success: function(wlogResponse) {
						wlogCodeNameList = wlogResponse.wlogCodeList;
						for (let j = 0; j < wlogCodeNameList.length; j++) {
							var rowWlog = document.createElement('td');
							rowWlog.innerHTML=stdtList[i].wlogCnt.split(',')[j].substr(10);
							newRow.appendChild(rowWlog);
						}
						},error: function(error){console.log("error: ", error);}
					})
					var rowGender = document.createElement('td');
					rowGender.innerHTML=stdtList[i].genderCd;
					var rowBirth = document.createElement('td');
					rowBirth.innerHTML=stdtList[i].birthDd;
					var rowEmail = document.createElement('td');
					rowEmail.innerHTML=stdtList[i].userEmail;
					var rowTel = document.createElement('td');
					rowTel.innerHTML=stdtList[i].stdtTel;
					var rowJob = document.createElement('td');
					rowJob.innerHTML=stdtList[i].jobCd;
					
					newRow.appendChild(rowGender);
					newRow.appendChild(rowBirth);
					newRow.appendChild(rowEmail);
					newRow.appendChild(rowTel);
					newRow.appendChild(rowJob);
					
					console.log(newRow);
					console.log(stdtListTable);
					
					stdtListTable.append(newRow);
				}

			},error: function(error){
				console.log("error: ", error);
			}
		})
	}

	//검색 클릭 이벤트
	const searchBtn = document.querySelector("#search_btn");
	searchBtn.addEventListener("click", () => {
		//교육과정명
		var className = document.querySelector("#class_name").value;
					
		//교육과정 상태값 가져오기
		var statusArray = new Array();
		$('input:checkbox[name=chk_status]:checked').each(function(){
			statusArray.push(this.value);			
		});
		
		//교육과정 지원 시작
		var aplyStartDt = document.querySelector("#aply_start_dt").value;
		
		//교육과정 지원 마감
		var aplyEndDt = document.querySelector("#aply_end_dt").value;
		
		//교육과정 시작일
		var classStartDd = document.querySelector("#class_start_dd").value;
		
		//교육과정 종료일
		var classEndDd = document.querySelector("#class_end_dd").value;
		
		console.log("className: " +className);
		console.log("statusArray: " +statusArray);
		console.log("aply: "+aplyStartDt+"~"+aplyEndDt);
		console.log("class: "+classStartDd+"~"+classEndDd);

	$.ajax({
		url: '/admin/class/search',
		async: true,
		method: 'GET',
		data: {
			className: className, 
			statusArray: statusArray,
			aplyStartDt: aplyStartDt,
			aplyEndDt: aplyEndDt,
			classStartDd: classStartDd,
			classEndDd: classEndDd},
		success: function(response) {
			var classListTable = document.querySelector("#class_list_table");
			var classList = classListTable.querySelectorAll("#class_list");
			classListTable.firstElementChild.remove();
			var classListCode=
				'<tr>'+'<th><input type="checkbox" name="chk" id="chkAll"></th>'+
				'<th th:if="${session.role==\'admin\'}">ID</th>'+
				'<th>프로그램명</th>'+'	<th th:if="${session.role==\'admin\'}">지원기간</th>'+
				'<th>교육기간</th>'+'<th>교육 장소</th>'+'<th>신청/최대</th>'+'<th>교육상태</th></tr>';
			for(var i = 0; i < response.length; i++){
			classListCode += 
				'<tr><td><input type="checkbox" name="chk" th:value="'+
				response[i].clssId+'"></td>'+
				'<td>'+response[i].clssId+'</td>'+
				'<td><a class="content_title" th:href="@{/manager/class/__'+response[i].clssId +
				'__}">'+response[i].clssNm+'</a></td>' +
				'<td><span>'+response[i].aplyStartDt+'</span> <br>~<br>'+
				'<span>'+response[i].aplyEndDt+'</span></td>'+
				'<td><span>'+response[i].clssStartDd+'</span> <br>~<br>'+
				'<span>'+response[i].clssEndDd+'</span></td>'+
				'<td>'+response[i].clssAdr+'</td>'+
				'<td><span>' + response[i].aplyCnt + '</span> / <span>'+response[i].limitCnt+'</span></td>'+
				'<td>'+response[i].clssCd+'</td></tr>';
			}
			classListTable.innerHTML=classListCode;
		},
		error: function(error){
			console.log("error: ", error);
		}
	});
});
	
</script>

</body>
</html>